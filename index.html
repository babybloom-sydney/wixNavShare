<script>
  // 1. We need 'pako' to decompress the data from the URL
  // You must have this script tag in your <head>
  // <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  // Wait for the HTML document to be ready
  document.addEventListener('DOMContentLoaded', () => {
    const loader = document.getElementById('loader');
    const debug = document.getElementById('debug');

    try {
      // 2. Get the URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const dataParam = urlParams.get('data'); // e.g., ?data=eJy1V...

      if (!dataParam) {
        throw new Error('No data param in URL');
      }
      
      debug.innerHTML = `Found data param (${dataParam.length} chars)<br>Decoding...`;

      // 3. Decode the URL-safe Base64 string
      // We replace URL-safe chars '-' and '_' back to '+' and '/'
      const base64Data = dataParam.replace(/-/g, '+').replace(/_/g, '/');
      const compressedData = atob(base64Data); // 'atob' decodes Base64

      // 4. Decompress the data
      // Convert the binary string to a Uint8Array for pako
      const compressedArray = new Uint8Array(compressedData.length).map((_, i) => compressedData.charCodeAt(i));
      const jsonString = pako.inflate(compressedArray, { to: 'string' });

      debug.innerHTML += `<br>Decompressed to JSON (${jsonString.length} chars)`;

      // 5. Parse the JSON
      const data = JSON.parse(jsonString);

      if (!data.contactId) {
        throw new Error('Data is corrupt or missing contactId');
      }

      // 6. We have the data! Render the preview.
      renderPreview(data);

    } catch (err) {
      // Handle any errors in the process
      loader.innerHTML = `<div class="error">Error: ${err.message}</div>`;
      if (debug) {
        debug.innerHTML += `<br><strong>Failed:</strong> ${err.message}`;
      }
    }
  });

  /**
   * This function takes the final data and populates the HTML.
   * It also sets up the corrected button logic.
   */
  function renderPreview(data) {
    const loader = document.getElementById('loader');
    const debug = document.getElementById('debug');
    
    // Create the final data object, filling in defaults
    const profileData = {
      contactId: data.contactId,
      firstName: data.firstName || 'Nanny',
      suburb: data.suburb || 'Sydney',
      profilePicture: data.profilePicture || 'https://randomuser.me/api/portraits/women/44.jpg', // Default pic
      nanny_ad: data.nanny_ad || data.profilePicture || '', // Fallback to profile pic
      bioNanny: data.bioNanny || '',
      shareUrl: `https.babybloomsydney.com.au/nanny/${data.contactId}`
    };

    // Remove loading elements
    if (loader) loader.remove();
    if (debug) debug.remove();

    // Show the content
    document.querySelector('.copy-container').style.display = 'flex';
    document.querySelector('.fb-post').style.display = 'block';

    // Populate the content
    document.getElementById('profilePic').src = profileData.profilePicture;
    document.getElementById('userName').textContent = profileData.firstName;
    document.getElementById('previewImage').src = profileData.nanny_ad;
    document.getElementById('previewTitle').textContent = `Experienced Nanny Available | ${profileData.suburb}`;
    document.getElementById('previewDesc').textContent = `Hi, I'm ${profileData.firstName} and I'm now available to Nanny!`;

    // Set the post text from HTML
    document.getElementById('postText').innerHTML = profileData.bioNanny;
    
    // === CORRECTED BUTTON LOGIC ===
    const copyBtn = document.getElementById('copyBtn');
    const shareBtn = document.getElementById('shareBtn');
    
    // --- COPY BUTTON FIX ---
    copyBtn.addEventListener('click', () => {
      // 1. Create a plain text version from the bio HTML
      let copyText = profileData.bioNanny;
      
      // 2. Replace <br> tags with newline characters
      copyText = copyText.replace(/<br\s*\/?>/gi, '\n');
      
      // 3. Strip all other HTML tags
      copyText = copyText.replace(/<[^>]*>/g, '');
      
      // 4. Decode any HTML entities (like &amp; -> &)
      const tempEl = document.createElement('textarea');
      tempEl.innerHTML = copyText;
      copyText = tempEl.value;

      // 5. Write the *clean text* to the clipboard
      navigator.clipboard.writeText(copyText).then(() => {
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy Post', 2000);
      });
    });
    
    // --- SHARE BUTTON FIX ---
    shareBtn.addEventListener('click', () => {
      // This button shares the *actual profile URL*, not the preview page
      if (navigator.share) {
        // Use Web Share API (Mobile)
        navigator.share({
          title: `Nanny Profile: ${profileData.firstName}`,
          text: `Check out ${profileData.firstName}'s profile!`,
          url: profileData.shareUrl // <-- USES THE CORRECT URL
        });
      } else {
        // Fallback for Desktop (Copy link to clipboard)
        navigator.clipboard.writeText(profileData.shareUrl).then(() => { // <-- USES THE CORRECT URL
          shareBtn.textContent = 'Link Copied!';
          setTimeout(() => shareBtn.textContent = 'Share Profile', 2000);
        });
      }
    });
  }
</script>
